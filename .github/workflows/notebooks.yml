# Run class-2 notebooks on Python 3.10 and 3.12; comment on PRs with results.
name: Notebooks

on:
  push:
    branches: [main]
    paths: ['class-2-machine-learning-basics/**', '.github/workflows/notebooks.yml', 'requirements.txt']
  pull_request:
    branches: [main]
    paths: ['class-2-machine-learning-basics/**', '.github/workflows/notebooks.yml', 'requirements.txt']

jobs:
  run-notebooks:
    name: Run on Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jupyter nbconvert
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f class-2-machine-learning-basics/requirements.txt ]; then pip install -r class-2-machine-learning-basics/requirements.txt; fi

      - name: Execute notebooks
        id: run
        run: |
          cd class-2-machine-learning-basics || exit 1
          err=0
          for f in *.ipynb; do
            echo "Running $f ..."
            if ! jupyter nbconvert --to notebook --execute --ExecutePreprocessor.timeout=300 --stdout "$f" > /dev/null; then
              echo "::error::Notebook failed: $f"
              err=1
            fi
          done
          exit $err

  pr-comment:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: run-notebooks
    if: always() && github.event_name == 'pull_request' && (needs.run-notebooks.result == 'success' || needs.run-notebooks.result == 'failure')
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Comment PR with result
        uses: actions/github-script@v7
        with:
          script: |
            const job = '${{ needs.run-notebooks.result }}';
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const body = job === 'success'
              ? '✅ **Notebooks:** All class-2 notebooks ran successfully on Python 3.10 and 3.12.'
              : `❌ **Notebooks:** One or more runs failed on Python 3.10 or 3.12. See [workflow run](${runUrl}) for details.`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
